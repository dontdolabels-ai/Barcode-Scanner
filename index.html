<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <title>Delivery Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 1.5rem 1rem; text-align: center; }
        .header h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .container { padding: 1rem; max-width: 600px; margin: 0 auto; }
        .scanner-section { background: #1e293b; border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; }
        #scanner { 
            border-radius: 0.5rem; 
            overflow: hidden; 
            width: 100%; 
            height: 400px;
            margin: 0 auto;
            position: relative;
            background: #000;
        }
        #scanner video,
        #scanner canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .btn { flex: 1; min-width: 120px; padding: 0.875rem 1rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn:disabled { opacity: 0.5; }
        .scanner-controls { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .manual-entry { margin-top: 1rem; }
        .manual-entry input { width: 100%; padding: 0.875rem; border: 2px solid #334155; border-radius: 0.5rem; background: #0f172a; color: white; font-size: 1rem; margin-bottom: 0.5rem; }
        .status-message { margin-top: 1rem; padding: 1rem; border-radius: 0.5rem; font-weight: 600; text-align: center; display: none; }
        .status-success { background: #065f46; color: #d1fae5; }
        .status-error { background: #991b1b; color: #fecaca; }
        .status-warning { background: #92400e; color: #fef3c7; }
        .status-info { background: #1e40af; color: #dbeafe; }
        .deliveries-section { background: #1e293b; border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; }
        .deliveries-section h2 { font-size: 1.25rem; margin-bottom: 1rem; color: #60a5fa; }
        .delivery-card { background: #0f172a; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; border: 2px solid #334155; }
        .delivery-card.complete { border-color: #10b981; }
        .delivery-card.incomplete { border-color: #f59e0b; }
        .delivery-location { font-size: 1.5rem; font-weight: 800; color: #3b82f6; }
        .delivery-date { font-size: 0.875rem; color: #94a3b8; }
        .progress-bar { width: 100%; height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin: 0.75rem 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: width 0.3s; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 0.5rem; margin-top: 0.75rem; }
        .item-badge { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; font-weight: 700; font-size: 0.875rem; border: 2px solid; }
        .item-badge.scanned { background: #065f46; border-color: #10b981; color: #d1fae5; }
        .item-badge.missing { background: #334155; border-color: #475569; color: #64748b; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: #64748b; }
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 150px;
            border: 3px solid #3b82f6;
            border-radius: 10px;
            pointer-events: none;
            z-index: 10;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header"><h1>📦 Delivery Scanner</h1></div>
    <div class="container">
        <div class="scanner-section">
            <div id="scanner" class="hidden">
                <div class="scan-overlay"></div>
            </div>
            <div class="scanner-controls">
                <button class="btn btn-primary" id="startBtn">Start Scanner</button>
                <button class="btn btn-danger hidden" id="stopBtn">Stop Scanner</button>
            </div>
            <div style="text-align: center; padding: 1rem; color: #64748b;">- OR -</div>
            <div class="manual-entry">
                <input type="text" id="manualInput" placeholder="Type: BH 01/01/25 STD 1/8" />
                <button class="btn btn-success" id="manualBtn">Add Manual Entry</button>
            </div>
            <div id="statusMessage" class="status-message"></div>
        </div>
        <div class="deliveries-section"><h2>Active Deliveries</h2><div id="deliveriesList"></div></div>
    </div>
    <script>
        let isScanning = false, deliveries = {}, detectionBuffer = [];
        
        function parseBarcode(text) {
            const match = text.trim().match(/^([A-Z]{2,3})\s+(\d{2}\/\d{2}\/\d{2})\s+(STD|CAKE)\s+(\d+)\/(\d+)$/);
            return match ? { location: match[1], date: match[2], type: match[3], current: parseInt(match[4]), total: parseInt(match[5]) } : null;
        }
        
        function addScannedItem(data) {
            const key = `${data.location}_${data.date}_${data.type}`;
            if (!deliveries[key]) deliveries[key] = { ...data, scanned: new Set(), timestamp: Date.now() };
            if (deliveries[key].scanned.has(data.current)) return showStatus(`Already scanned ${data.current}/${data.total}`, 'warning');
            deliveries[key].scanned.add(data.current);
            if (data.total > deliveries[key].total) deliveries[key].total = data.total;
            renderDeliveries();
            const done = deliveries[key].scanned.size === deliveries[key].total;
            showStatus(done ? `✓ ${data.location} COMPLETE!` : `Scanned ${data.location} ${data.current}/${data.total}`, done ? 'success' : 'info');
            if ('vibrate' in navigator) navigator.vibrate(done ? [100,50,100] : 100);
        }
        
        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.className = `status-message status-${type}`;
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        
        function calculateQuality(result) {
            let quality = 0;
            if (result.decodedCodes) {
                const errors = result.decodedCodes.reduce((sum, code) => sum + (code.error || 0), 0);
                quality = 1 - (errors / result.decodedCodes.length);
            }
            return quality;
        }

        function isConsistentDetection(code) {
            if (detectionBuffer.length < 2) return false;
            const recentMatches = detectionBuffer.filter(d => 
                d.code === code && 
                Date.now() - d.timestamp < 1000 &&
                d.quality > 0.65
            );
            return recentMatches.length >= 2;
        }
        
        async function startScanner() {
            try {
                showStatus('Starting camera...', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                stream.getTracks().forEach(t => t.stop());

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner'),
                        constraints: {
                            width: { min: 640, ideal: 1920 },
                            height: { min: 480, ideal: 1080 },
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "large",
                        halfSample: false
                    },
                    numOfWorkers: navigator.hardwareConcurrency || 4,
                    frequency: 5,
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ]
                    },
                    locate: true
                }, (err) => {
                    if (err) {
                        console.error('Scanner init error:', err);
                        showStatus('Camera error. Try manual entry.', 'error');
                        return;
                    }
                    
                    isScanning = true;
                    document.getElementById('scanner').classList.remove('hidden');
                    document.getElementById('startBtn').classList.add('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    showStatus('Scanner active - Point at barcode', 'info');
                    
                    Quagga.start();
                    
                    Quagga.onDetected((data) => {
                        const code = data.codeResult.code;
                        const quality = calculateQuality(data.codeResult);
                        
                        detectionBuffer.push({
                            code: code,
                            quality: quality,
                            timestamp: Date.now()
                        });
                        
                        if (detectionBuffer.length > 5) detectionBuffer.shift();
                        
                        if (isConsistentDetection(code)) {
                            const parsed = parseBarcode(code);
                            if (parsed) {
                                addScannedItem(parsed);
                                detectionBuffer = [];
                            }
                        }
                    });
                });
            } catch (err) {
                console.error('Camera error:', err);
                showStatus('Camera permission denied', 'error');
            }
        }
        
        function stopScanner() {
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
                document.getElementById('scanner').classList.add('hidden');
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                detectionBuffer = [];
                showStatus('Scanner stopped', 'info');
            }
        }
        
        document.getElementById('manualBtn').onclick = () => {
            const txt = document.getElementById('manualInput').value.trim();
            if (!txt) return showStatus('Enter a barcode', 'error');
            const data = parseBarcode(txt);
            if (data) { addScannedItem(data); document.getElementById('manualInput').value = ''; }
            else showStatus('Invalid format. Use: BH 01/01/25 STD 1/8', 'error');
        };
        
        document.getElementById('manualInput').onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('manualBtn').click(); };
        document.getElementById('startBtn').onclick = startScanner;
        document.getElementById('stopBtn').onclick = stopScanner;
        
        function renderDeliveries() {
            const el = document.getElementById('deliveriesList');
            if (Object.keys(deliveries).length === 0) return el.innerHTML = '<div class="empty-state">No deliveries scanned yet</div>';
            el.innerHTML = Object.entries(deliveries).sort((a,b) => b[1].timestamp - a[1].timestamp).map(([k, d]) => {
                const prog = (d.scanned.size / d.total) * 100, done = d.scanned.size === d.total;
                const missing = Array.from({length: d.total}, (_,i) => i+1).filter(n => !d.scanned.has(n));
                const items = Array.from({length: d.total}, (_,i) => {
                    const n = i+1; return `<div class="item-badge ${d.scanned.has(n)?'scanned':'missing'}">${n}</div>`;
                }).join('');
                return `<div class="delivery-card ${done?'complete':'incomplete'}">
                    <div class="delivery-location">${d.location}</div>
                    <div class="delivery-date">${d.date} - ${d.type}</div>
                    <div style="font-size: 0.875rem; color: #94a3b8; margin: 0.5rem 0;">${d.scanned.size} of ${d.total} scanned</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: ${prog}%"></div></div>
                    ${missing.length > 0 ? `<div style="color: #f59e0b; font-size: 0.875rem;">⚠️ Missing: ${missing.join(', ')}</div>` : ''}
                    <div class="items-grid">${items}</div>
                    <button class="btn btn-danger" onclick="deliveries['${k}']=undefined;delete deliveries['${k}'];renderDeliveries()" style="width:100%; margin-top:1rem;">Clear</button>
                </div>`;
            }).join('');
        }
        renderDeliveries();
    </script>
</body>
</html>
