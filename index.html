<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .scanner-container {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #scanner {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #scanner canvas,
        #scanner video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        .scan-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            transform: translateY(-50%);
            animation: scan 2s ease-in-out infinite;
            box-shadow: 0 0 10px #00ff00;
        }

        @keyframes scan {
            0%, 100% { opacity: 0.3; top: 40%; }
            50% { opacity: 1; top: 60%; }
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 400px;
            height: 250px;
            border: 3px solid #00ff00;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .scan-frame::before,
        .scan-frame::after,
        .corner-tl,
        .corner-tr,
        .corner-bl,
        .corner-br {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid #00ff00;
        }

        .corner-tl {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
        }

        .corner-tr {
            top: -4px;
            right: -4px;
            border-left: none;
            border-bottom: none;
        }

        .corner-bl {
            bottom: -4px;
            left: -4px;
            border-right: none;
            border-top: none;
        }

        .corner-br {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
        }

        .scan-instructions {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
        }

        .controls {
            padding: 20px;
            background: #2a2a2a;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .status.ready {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .status.error {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
        }

        .status.scanning {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }

        .results {
            max-height: 200px;
            overflow-y: auto;
            background: #333;
            border-radius: 8px;
            padding: 15px;
        }

        .result-item {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 16px;
        }

        .result-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .no-results {
            text-align: center;
            opacity: 0.6;
            font-style: italic;
        }

        .hidden {
            display: none !important;
        }

        .settings {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .settings h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: #666;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: #667eea;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: left 0.3s;
        }

        .toggle.active::after {
            left: 27px;
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .controls {
                padding: 15px;
            }
            
            .scan-frame {
                width: 90%;
                height: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Barcode Scanner</h1>
            <p>Enhanced scanning for better accuracy</p>
        </div>

        <div class="scanner-container">
            <div id="scanner" class="hidden"></div>
            <div class="scanner-overlay">
                <div class="scan-frame">
                    <div class="corner-tl"></div>
                    <div class="corner-tr"></div>
                    <div class="corner-bl"></div>
                    <div class="corner-br"></div>
                </div>
                <div class="scan-line"></div>
                <div class="scan-instructions">
                    Hold barcode steady within the frame<br>
                    Good lighting helps accuracy
                </div>
            </div>
        </div>

        <div class="controls">
            <div id="status" class="status">Ready to scan</div>
            
            <div class="settings">
                <h3>‚öôÔ∏è Scan Settings</h3>
                <div class="setting-item">
                    <span>Continuous Scan</span>
                    <div class="toggle active" id="continuousToggle"></div>
                </div>
                <div class="setting-item">
                    <span>Sound Feedback</span>
                    <div class="toggle active" id="soundToggle"></div>
                </div>
            </div>
            
            <button id="startBtn" class="button">Start Scanner</button>
            <button id="stopBtn" class="button hidden">Stop Scanner</button>
            
            <div class="results">
                <h3 style="margin-bottom: 10px;">Scanned Codes:</h3>
                <div id="resultsList">
                    <div class="no-results">No codes scanned yet</div>
                </div>
                <button id="clearBtn" class="button" style="margin-top: 10px; font-size: 14px; padding: 10px;">Clear Results</button>
            </div>
        </div>
    </div>

    <script>
        class BarcodeScanner {
            constructor() {
                this.isScanning = false;
                this.scannedCodes = [];
                this.continuousMode = true;
                this.soundEnabled = true;
                this.lastDetectionTime = 0;
                this.detectionBuffer = [];
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.scanner = document.getElementById('scanner');
                this.resultsList = document.getElementById('resultsList');
                this.continuousToggle = document.getElementById('continuousToggle');
                this.soundToggle = document.getElementById('soundToggle');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
                this.clearBtn.addEventListener('click', () => this.clearResults());
                
                this.continuousToggle.addEventListener('click', () => {
                    this.continuousMode = !this.continuousMode;
                    this.continuousToggle.classList.toggle('active');
                });
                
                this.soundToggle.addEventListener('click', () => {
                    this.soundEnabled = !this.soundEnabled;
                    this.soundToggle.classList.toggle('active');
                });
            }

            updateStatus(message, type = 'ready') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }

            async startScanning() {
                try {
                    this.updateStatus('Initializing camera...', 'scanning');
                    
                    // Check for camera permission
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    });
                    stream.getTracks().forEach(track => track.stop());

                    // Enhanced Quagga configuration
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: this.scanner,
                            constraints: {
                                width: { min: 640, ideal: 1920 },
                                height: { min: 480, ideal: 1080 },
                                facingMode: "environment",
                                aspectRatio: { ideal: 16/9 }
                            },
                            area: { // Only scan the center area
                                top: "20%",
                                right: "10%",
                                left: "10%",
                                bottom: "20%"
                            }
                        },
                        locator: {
                            patchSize: "large", // Improved from medium
                            halfSample: false // Better quality
                        },
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        frequency: 5, // Reduced from 10 for better accuracy
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "code_39_reader",
                                "code_39_vin_reader",
                                "codabar_reader",
                                "upc_reader",
                                "upc_e_reader",
                                "i2of5_reader",
                                "2of5_reader",
                                "code_93_reader"
                            ],
                            debug: {
                                drawBoundingBox: false,
                                showFrequency: false,
                                drawScanline: false,
                                showPattern: false
                            },
                            multiple: false
                        },
                        locate: true
                    }, (err) => {
                        if (err) {
                            console.error('Quagga initialization failed:', err);
                            this.updateStatus('Camera initialization failed', 'error');
                            return;
                        }
                        
                        this.updateStatus('‚úì Scanning... Point at barcode', 'scanning');
                        this.isScanning = true;
                        this.scanner.classList.remove('hidden');
                        this.startBtn.classList.add('hidden');
                        this.stopBtn.classList.remove('hidden');
                        
                        Quagga.start();
                        
                        // Listen for processed frames
                        Quagga.onProcessed((result) => {
                            const drawingCtx = Quagga.canvas.ctx.overlay;
                            const drawingCanvas = Quagga.canvas.dom.overlay;

                            if (result) {
                                // Clear previous drawings
                                drawingCtx.clearRect(0, 0, 
                                    parseInt(drawingCanvas.getAttribute("width")), 
                                    parseInt(drawingCanvas.getAttribute("height")));
                                
                                // Draw detected boxes
                                if (result.boxes) {
                                    drawingCtx.strokeStyle = "rgba(0, 255, 0, 0.5)";
                                    result.boxes.filter(box => box !== result.box).forEach(box => {
                                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {
                                            color: "green",
                                            lineWidth: 2
                                        });
                                    });
                                }

                                // Draw the best box
                                if (result.box) {
                                    drawingCtx.strokeStyle = "rgba(0, 255, 0, 1)";
                                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {
                                        color: "#00FF00",
                                        lineWidth: 3
                                    });
                                }
                            }
                        });
                        
                        // Listen for successful scans with confidence checking
                        Quagga.onDetected((data) => {
                            // Check confidence level
                            const code = data.codeResult.code;
                            const quality = this.calculateQuality(data.codeResult);
                            
                            // Add to buffer for verification
                            this.detectionBuffer.push({
                                code: code,
                                quality: quality,
                                timestamp: Date.now()
                            });
                            
                            // Keep only last 5 detections
                            if (this.detectionBuffer.length > 5) {
                                this.detectionBuffer.shift();
                            }
                            
                            // Check if we have consistent reads
                            if (this.isConsistentDetection(code)) {
                                this.handleScan(code, data.codeResult.format);
                                this.detectionBuffer = []; // Clear buffer after successful scan
                            }
                        });
                    });

                } catch (error) {
                    console.error('Error starting camera:', error);
                    if (error.name === 'NotAllowedError') {
                        this.updateStatus('Camera permission denied', 'error');
                    } else if (error.name === 'NotFoundError') {
                        this.updateStatus('No camera found', 'error');
                    } else {
                        this.updateStatus('Camera error: ' + error.message, 'error');
                    }
                }
            }

            calculateQuality(result) {
                // Calculate overall quality score
                let quality = 0;
                
                if (result.decodedCodes) {
                    const errors = result.decodedCodes.reduce((sum, code) => {
                        return sum + (code.error || 0);
                    }, 0);
                    quality = 1 - (errors / result.decodedCodes.length);
                }
                
                return quality;
            }

            isConsistentDetection(code) {
                // Need at least 2 detections
                if (this.detectionBuffer.length < 2) return false;
                
                // Check if recent detections match
                const recentMatches = this.detectionBuffer.filter(d => 
                    d.code === code && 
                    Date.now() - d.timestamp < 1000 &&
                    d.quality > 0.65
                );
                
                return recentMatches.length >= 2;
            }

            stopScanning() {
                if (this.isScanning) {
                    Quagga.stop();
                    this.isScanning = false;
                    this.scanner.classList.add('hidden');
                    this.startBtn.classList.remove('hidden');
                    this.stopBtn.classList.add('hidden');
                    this.updateStatus('Scanner stopped', 'ready');
                    this.detectionBuffer = [];
                }
            }

            handleScan(code, format) {
                const now = Date.now();
                
                // Prevent duplicate scans within 3 seconds
                const isDuplicate = this.scannedCodes.some(item => 
                    item.code === code && (now - item.timestamp) < 3000
                );

                if (!isDuplicate) {
                    const scanResult = {
                        code: code,
                        format: format,
                        timestamp: now,
                        time: new Date().toLocaleTimeString()
                    };

                    this.scannedCodes.unshift(scanResult);
                    this.updateResults();
                    this.updateStatus(`‚úì Scanned: ${code}`, 'ready');
                    
                    // Feedback
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                    
                    if (this.soundEnabled) {
                        this.playBeep();
                    }
                    
                    // Auto-stop if not in continuous mode
                    if (!this.continuousMode) {
                        setTimeout(() => this.stopScanning(), 1000);
                    }
                }
            }

            playBeep() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.15);
                } catch (e) {
                    console.log('Audio not available');
                }
            }

            updateResults() {
                if (this.scannedCodes.length === 0) {
                    this.resultsList.innerHTML = '<div class="no-results">No codes scanned yet</div>';
                } else {
                    this.resultsList.innerHTML = this.scannedCodes.map(item => `
                        <div class="result-item">
                            <div>
                                <div class="result-code">${item.code}</div>
                                <div class="result-time">${item.format} ‚Ä¢ ${item.time}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            clearResults() {
                this.scannedCodes = [];
                this.updateResults();
                this.updateStatus('Results cleared', 'ready');
            }
        }

        // Initialize the scanner when the page loads
        let scannerInstance;
        document.addEventListener('DOMContentLoaded', () => {
            scannerInstance = new BarcodeScanner();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && scannerInstance && scannerInstance.isScanning) {
                scannerInstance.stopScanning();
            }
        });
    </script>
</body>
</html>
