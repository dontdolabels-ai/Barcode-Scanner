<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Delivery Scanner">
    <meta name="description" content="Scan and track delivery barcodes">
    
    <title>Delivery Scanner</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRGVsaXZlcnkgU2Nhbm5lciIsInNob3J0X25hbWUiOiJTY2FubmVyIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMxZTQwYWYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyB2aWV3Qm94PScwIDAgMTkyIDE5MiclM0UlM0NyZWN0IHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyBmaWxsPSclMjMxZTQwYWYnLyUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBkb21pbmFudC1iYXNlbGluZT0nbWlkZGxlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzgwJyUzRSVGMCU5RiU5MyVBNiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIHZpZXdCb3g9JzAgMCA1MTIgNTEyJyUzRSUzQ3JlY3Qgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIGZpbGw9JyUyMzFlNDBhZicvJTNFJTNDdGV4dCB4PSc1MCUyNScgeT0nNTAlMjUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZvbnQtc2l6ZT0nMjQwJyUzRSVGMCU5RiU5MyVBNiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%231e40af'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='80'%3E📦%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: white;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .install-prompt {
            background: #059669;
            color: white;
            padding: 1rem;
            text-align: center;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-prompt button {
            background: white;
            color: #059669;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
        }

        .container {
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .https-warning {
            background: #92400e;
            color: #fef3c7;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .scanner-section {
            background: #1e293b;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #reader {
            border-radius: 0.5rem;
            overflow: hidden;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .scanner-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 0.875rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:active {
            background: #2563eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:active {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:active {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .use-file-upload {
            margin-top: 1rem;
            padding: 1.25rem;
            background: #7c3aed;
            border-radius: 0.75rem;
            text-align: center;
        }

        .use-file-upload input[type="file"] {
            display: none;
        }

        .use-file-upload label {
            display: inline-block;
            padding: 1rem 2rem;
            background: white;
            color: #7c3aed;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 0.75rem;
            font-size: 1rem;
        }

        .use-file-upload label:active {
            background: #e5e7eb;
        }

        .upload-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .upload-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .manual-entry {
            margin-top: 1rem;
        }

        .manual-entry input {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #334155;
            border-radius: 0.5rem;
            background: #0f172a;
            color: white;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .manual-entry input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .status-success {
            background: #065f46;
            color: #d1fae5;
        }

        .status-error {
            background: #991b1b;
            color: #fecaca;
        }

        .status-warning {
            background: #92400e;
            color: #fef3c7;
        }

        .status-info {
            background: #1e40af;
            color: #dbeafe;
        }

        .deliveries-section {
            background: #1e293b;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .deliveries-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #60a5fa;
        }

        .delivery-card {
            background: #0f172a;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #334155;
        }

        .delivery-card.complete {
            border-color: #10b981;
        }

        .delivery-card.incomplete {
            border-color: #f59e0b;
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .delivery-location {
            font-size: 1.5rem;
            font-weight: 800;
            color: #3b82f6;
        }

        .delivery-date {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .delivery-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .delivery-type.standard {
            background: #1e40af;
            color: #dbeafe;
        }

        .delivery-type.cake {
            background: #991b1b;
            color: #fecaca;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.75rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            transition: width 0.3s ease;
        }

        .progress-fill.complete {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .progress-text {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .item-badge {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 0.875rem;
            border: 2px solid;
        }

        .item-badge.scanned {
            background: #065f46;
            border-color: #10b981;
            color: #d1fae5;
        }

        .item-badge.missing {
            background: #334155;
            border-color: #475569;
            color: #64748b;
        }

        .delivery-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .camera-error {
            background: #991b1b;
            color: #fecaca;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: left;
            line-height: 1.6;
        }

        .complete-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: #065f46;
            color: #d1fae5;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="install-prompt" id="installPrompt">
        <div>📱 Add to Home Screen for easier access!</div>
        <div>
            <button onclick="installApp()">Install</button>
            <button onclick="dismissInstall()" style="background: transparent; color: white; margin-left: 0.5rem;">Later</button>
        </div>
    </div>

    <div class="header">
        <h1>📦 Delivery Scanner</h1>
        <div class="subtitle">Scan barcodes to track deliveries</div>
    </div>

    <div class="container">
        <div id="httpsWarning" class="https-warning" style="display: none;">
            ⚠️ Camera requires HTTPS. Use photo upload or manual entry below.
        </div>

        <div class="scanner-section">
            <div class="use-file-upload">
                <div class="upload-title">📸 Take a Photo</div>
                <div class="upload-subtitle">Point at barcode and upload the photo</div>
                <label for="fileInput">
                    📷 Choose Photo
                    <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleFileUpload(event)">
                </label>
            </div>

            <div style="text-align: center; padding: 1rem 0; color: #64748b; font-weight: 600;">
                - OR -
            </div>

            <div id="reader"></div>
            
            <div class="scanner-controls">
                <button class="btn btn-primary" id="startBtn" onclick="startScanner()">Start Live Scanner</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopScanner()" disabled>Stop Scanner</button>
            </div>

            <div style="text-align: center; padding: 1rem 0; color: #64748b; font-weight: 600;">
                - OR -
            </div>

            <div class="manual-entry">
                <input type="text" id="manualInput" placeholder="Type barcode: BH 01/01/25 STD 1/8" />
                <button class="btn btn-success" onclick="processManualEntry()">⌨️ Add Manual Entry</button>
            </div>

            <div id="statusMessage"></div>
        </div>

        <div class="deliveries-section">
            <h2>Active Deliveries</h2>
            <div id="deliveriesList"></div>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        let isScanning = false;
        let deliveries = {};
        let deferredPrompt;

        // PWA Install prompt handling
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        async function installApp() {
            if (!deferredPrompt) {
                alert('Installation not available. Try using "Add to Home Screen" from your browser menu.');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                document.getElementById('installPrompt').classList.remove('show');
            }
            
            deferredPrompt = null;
        }

        function dismissInstall() {
            document.getElementById('installPrompt').classList.remove('show');
        }

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (event) => {
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', (event) => {
                        event.waitUntil(clients.claim());
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('Service Worker registered'))
                    .catch((err) => console.log('Service Worker registration failed:', err));
            });
        }

        function parseBarcode(text) {
            const pattern = /^([A-Z]{2,3})\s+(\d{2}\/\d{2}\/\d{2})\s+(STD|CAKE)\s+(\d+)\/(\d+)$/;
            const match = text.trim().match(pattern);
            
            if (!match) {
                return null;
            }
            
            return {
                location: match[1],
                date: match[2],
                type: match[3],
                current: parseInt(match[4]),
                total: parseInt(match[5]),
                raw: text.trim()
            };
        }

        function getDeliveryKey(location, date, type) {
            return `${location}_${date}_${type}`;
        }

        function addScannedItem(data) {
            const key = getDeliveryKey(data.location, data.date, data.type);
            
            if (!deliveries[key]) {
                deliveries[key] = {
                    location: data.location,
                    date: data.date,
                    type: data.type,
                    total: data.total,
                    scanned: new Set(),
                    timestamp: Date.now()
                };
            }

            if (deliveries[key].scanned.has(data.current)) {
                showStatus(`Item ${data.current}/${data.total} already scanned for ${data.location}`, 'warning');
                return false;
            }

            deliveries[key].scanned.add(data.current);
            
            if (data.total > deliveries[key].total) {
                deliveries[key].total = data.total;
            }

            saveToStorage();
            renderDeliveries();
            
            const isComplete = deliveries[key].scanned.size === deliveries[key].total;
            const status = isComplete ? 'success' : 'info';
            const message = isComplete 
                ? `✓ ${data.location} ${data.type} COMPLETE! (${deliveries[key].scanned.size}/${data.total})`
                : `Scanned ${data.location} ${data.type} ${data.current}/${data.total} (${deliveries[key].scanned.size} total)`;
            
            showStatus(message, status);
            
            if ('vibrate' in navigator) {
                navigator.vibrate(isComplete ? [100, 50, 100] : 100);
            }
            
            return true;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function onScanSuccess(decodedText, decodedResult) {
            const data = parseBarcode(decodedText);
            
            if (!data) {
                showStatus('Invalid barcode format', 'error');
                return;
            }
            
            addScannedItem(data);
        }

        function onScanError(errorMessage) {
            // Silently ignore scan errors
        }

        async function startScanner() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showStatus('Camera not supported in this browser. Use photo upload instead.', 'error');
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment" } 
                    });
                    stream.getTracks().forEach(track => track.stop());
                } catch (permErr) {
                    showStatus('Camera permission denied. Use photo upload or manual entry.', 'error');
                    showCameraHelp();
                    return;
                }

                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("reader");
                }
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 150 },
                    aspectRatio: 1.777778
                };
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );
                
                isScanning = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                showStatus('Scanner started - point camera at barcode', 'info');
                
            } catch (err) {
                console.error('Scanner error:', err);
                let errorMsg = 'Cannot access camera. ';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMsg += 'Please allow camera permission.';
                    showCameraHelp();
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMsg += 'No camera found on device.';
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMsg += 'Camera is being used by another app.';
                } else if (err.name === 'OverconstrainedError') {
                    errorMsg += 'Camera does not meet requirements.';
                } else if (err.name === 'TypeError') {
                    errorMsg += 'Camera not supported. Try using HTTPS.';
                } else {
                    errorMsg += err.message || 'Unknown error.';
                }
                
                showStatus(errorMsg, 'error');
            }
        }

        function showCameraHelp() {
            const helpDiv = document.createElement('div');
            helpDiv.className = 'camera-error';
            helpDiv.innerHTML = `
                <strong>📷 Camera Access Issue</strong><br><br>
                <strong>For Pixel 4a:</strong><br>
                1. Tap the 🔒 or (i) icon in the Chrome address bar<br>
                2. Tap "Permissions"<br>
                3. Set Camera to "Allow"<br>
                4. Refresh the page<br><br>
                <strong>Or use Photo Upload above instead!</strong><br><br>
                <button onclick="this.parentElement.remove()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: white; color: #991b1b; border: none; border-radius: 0.375rem; font-weight: 600;">Close</button>
            `;
            
            const existingHelp = document.querySelector('.camera-error');
            if (existingHelp) {
                existingHelp.remove();
            }
            
            document.querySelector('.scanner-section').appendChild(helpDiv);
        }

        async function stopScanner() {
            if (html5QrCode && isScanning) {
                await html5QrCode.stop();
                isScanning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                showStatus('Scanner stopped', 'info');
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showStatus('📸 Processing image...', 'info');
            
            try {
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("reader");
                }
                
                const result = await html5QrCode.scanFile(file, true);
                const data = parseBarcode(result);
                
                if (!data) {
                    showStatus('Could not read barcode from image. Try a clearer photo or manual entry.', 'error');
                    return;
                }
                
                addScannedItem(data);
                
            } catch (err) {
                console.error('File scan error:', err);
                showStatus('Could not scan image. Try manual entry instead.', 'error');
            }
            
            event.target.value = '';
        }

        function processManualEntry() {
            const input = document.getElementById('manualInput');
            const text = input.value.trim();
            
            if (!text) {
                showStatus('Please enter a barcode', 'error');
                return;
            }
            
            const data = parseBarcode(text);
            
            if (!data) {
                showStatus('Invalid format. Expected: BH 01/01/25 STD 1/8', 'error');
                return;
            }
            
            if (addScannedItem(data)) {
                input.value = '';
            }
        }

        function renderDeliveries() {
            const container = document.getElementById('deliveriesList');
            
            if (Object.keys(deliveries).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div>No deliveries scanned yet</div>
                    </div>
                `;
                return;
            }
            
            const sorted = Object.entries(deliveries).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            container.innerHTML = sorted.map(([key, delivery]) => {
                const progress = (delivery.scanned.size / delivery.total) * 100;
                const isComplete = delivery.scanned.size === delivery.